#Comment to trigger commit

version: 2.1

parameters:
  # This parameter is used to trigger the main workflow
  trigger:
    type: boolean
    default: true

  # A parameter per package
  api:
    type: boolean
    default: false
  app:
    type: boolean
    default: false

executors:
  node:
    docker:
      - image: circleci/node

jobs:
  trigger-workflows:
    executor: node
    steps:
      - checkout
      - run:
          name: Trigger workflows
#          command: chmod +x .circleci/circle_trigger.sh && .circleci/circle_trigger.sh
          command: echo "Scanned the libraries and detected a change. Triggering associated workflow....."

  build:
    parameters:
      MVN_PARAMS:
        type: string

    executor: node
    working_directory: ~/project/packages

    steps:
      - checkout:
          path: ~/project
      # This step is added only to show that we are in the package directory
      - run:
          name: Content 
          command: |
            echo $DISPLAY
            mvn -B -f pom.xml clean install -V -U -Dacceptance.test.log.level=INFO -Dtycho.localArtifacts=ignore -Dsurefire.rerunFailingTestsCount=2 -Pacceptance,deployment-plugins << parameters.MVN_PARAMS >> -s ctc.settings.xml 

workflows:
  version: 2

  # The main workflow responsible for triggering all other workflows
  # in which changes are detected.
  ci:
    when: << pipeline.parameters.trigger >>
    jobs:
      - trigger-workflows


  # Workflows defined for each package.

  api:
    when: << pipeline.parameters.api >>
    jobs:
      - build:
          name: api-build
          MVN_PARAMS: -Dacceptance.hds.rdbms.type=mysql -Dacceptance.hds.url=jdbc:mysql://localhost:3306 -Dacceptance.hds.dbuser=admin -Dacceptance.hds.password=Pa66word

  app:
    when: << pipeline.parameters.app >>
    jobs:
      - build:
          name: app-build
          MVN_PARAMS: -Dacceptance.hds.rdbms.type=mysql -Dacceptance.hds.url=jdbc:mysql://localhost:3306 -Dacceptance.hds.dbuser=root -Dacceptance.hds.password=Pa55word

